<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moteur de Recherche et Suppression d'Heures</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2a64c4; 
            --success-color: #4CAF50; 
            --error-color: #F44336;
            --text-color: #333;
            --bg-color: #f7f9fc;
            --secondary-button: #ff9800;
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding: 10px; /* Moins de padding sur mobile */
        }
        .container {
            background-color: white; padding: 20px; /* Moins de padding */
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px;
        }
        h1 { 
            color: var(--primary-color); 
            font-size: 1.5em; /* Taille r√©duite */
            margin-bottom: 15px; text-align: center; 
        }
        h3 { color: var(--primary-color); padding: 5px 0; margin: 15px 0 5px 0; }
        
        /* === ADAPTATION MOBILE DES CONTR√îLES === */
        .controls { 
            display: flex; 
            flex-direction: column; /* Empilement vertical par d√©faut */
            gap: 10px; 
            margin-bottom: 20px; 
            align-items: stretch; /* Les √©l√©ments prennent toute la largeur */
        }
        .controls label {
            font-weight: bold;
        }
        input[type="text"] { 
            padding: 12px; /* Plus grand pour le doigt */
            border: 1px solid #ddd; border-radius: 6px; 
            width: auto; /* N√©cessaire pour l'align-items: stretch */
        }
        
        /* Styles des boutons (g√©n√©raux) */
        button {
            padding: 12px 15px; /* Plus grand pour le doigt */
            border: none; border-radius: 6px;
            font-size: 1em; font-weight: bold; color: white; cursor: pointer;
            background-color: var(--primary-color); transition: background-color 0.2s;
            width: 100%; /* Prend toute la largeur dans la configuration mobile par d√©faut */
            box-sizing: border-box;
        }
        .controls button {
            width: 100%;
        }

        /* Groupement des boutons Rechecher et Afficher/Masquer */
        .controls-group {
            display: flex;
            gap: 10px;
        }
        .controls-group button {
            width: 50%;
        }

        #toggle-raw-data { background-color: var(--secondary-button); }
        
        /* Bouton de suppression */
        #delete-data { 
            background-color: var(--error-color); 
            font-size: 1.1em;
            padding: 15px 20px; /* Encore plus grand */
        }

        #loading-message { margin: 15px 0; font-weight: bold; color: var(--text-color); }
        
        /* === GESTION DES TABLEAUX SUR MOBILE === */
        .table-wrapper {
            overflow-x: auto; /* Permet le d√©filement horizontal */
            width: 100%;
            margin-top: 10px;
        }
        #report-output table, .raw-data-table { 
            width: 100%; 
            min-width: 600px; /* Force une largeur minimale pour les tableaux */
            border-collapse: collapse; 
        }
        #report-output th, #report-output td { 
            border: 1px solid #ddd; padding: 8px; /* Padding ajust√© */
            text-align: left; font-size: 0.8em; /* Taille de police r√©duite */
            white-space: nowrap; /* Emp√™che la coupure des en-t√™tes */
        }
        #report-output th { background-color: #f2f2f2; }
        .weekly-total, .grand-total { font-weight: bold; }
        .weekly-total { background-color: #d1e7dd; }
        .grand-total { background-color: #b8daff; }
        .raw-data-table th { background-color: #ffe0b2; }
        
        #download-pdf { background-color: var(--success-color); }

        .action-buttons {
            display: flex;
            flex-direction: column; /* Empilement vertical par d√©faut */
            gap: 10px;
            margin-top: 25px;
        }
        .action-buttons > div {
            display: flex;
            gap: 10px;
        }

        /* === Styles pour les √©crans plus larges (Tablette/Desktop) === */
        @media (min-width: 768px) {
            .controls {
                flex-direction: row; /* Repasse en ligne sur grand √©cran */
            }
            .controls-group {
                display: flex;
                gap: 10px;
            }
            .controls-group button {
                width: auto;
            }
            .action-buttons {
                flex-direction: row; /* Repasse en ligne sur grand √©cran */
                justify-content: space-between;
                align-items: center;
            }
            button {
                width: auto; /* Les boutons reprennent leur largeur de contenu */
            }
            .controls button {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Moteur de Recherche d'Heures de Travail</h1>
        
        <div class="controls">
            <label for="search_id">ID Employ√©/Nom :</label>
            <input type="text" id="search_id" placeholder="Ex: ID Employ√©/Nom">
            <div class="controls-group">
                <button onclick="fetchAndCalculate()">Rechercher</button>
                <button id="toggle-raw-data" style="display:none;" onclick="toggleRawData()">Masquer les donn√©es brutes</button>
            </div>
        </div>
        
        <div id="loading-message">Chargement des donn√©es...</div>
        <hr>
        
        <div id="report-output">
            </div>

        <div class="action-buttons">
            <button id="delete-data" style="display:none;" onclick="deleteEmployeeData()">
                ‚ö†Ô∏è SUPPRIMER TOUTES LES DONN√âES DE L'EMPLOY√â (BASE DE DONN√âES)
            </button>
            <button id="download-pdf" style="display:none;" onclick="generatePDF()">
                T√©l√©charger le PDF
            </button>
        </div>
    </div>

    <script>
        // <<<< REMPLACER CETTE LIGNE PAR VOTRE VRAI LIEN SHEETDB >>>>
        const API_URL = 'https://sheetdb.io/api/v1/coc8f5iflpnxi'; 
        let rawData = []; 
        let finalReportData = []; 
        const searchButton = document.querySelector('button[onclick="fetchAndCalculate()"]');
        const toggleButton = document.getElementById('toggle-raw-data');
        const deleteButton = document.getElementById('delete-data');
        let currentSearchId = ''; 

        // ----------------------------------------------------
        // FONCTIONS UTILITAIRES (Inchang√©es)
        // ----------------------------------------------------
        function normalizeId(text) {
            if (!text) return '';
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + String(weekNo).padStart(2, '0');
        }

        // ----------------------------------------------------
        // 1. CHARGEMENT INITIAL DES DONN√âES (Inchang√©e)
        // ----------------------------------------------------
        async function loadData() {
            searchButton.disabled = true;
            searchButton.textContent = "Chargement...";
            deleteButton.style.display = 'none';

            try {
                const response = await fetch(API_URL);
                rawData = await response.json();
                
                document.getElementById('loading-message').textContent = "‚úÖ Donn√©es charg√©es. Pr√™t √† rechercher.";
                
                searchButton.disabled = false;
                searchButton.textContent = "Rechercher";

            } catch (error) {
                document.getElementById('loading-message').textContent = `‚ùå Erreur de chargement des donn√©es. V√©rifiez votre URL API.`;
            }
        }
        loadData();

        // ----------------------------------------------------
        // 2. LOGIQUE DE CALCUL (Inchang√©e)
        // ----------------------------------------------------
        function calculateHours(employeeId) {
            const normalizedSearchId = normalizeId(employeeId);
            const employeeData = rawData.filter(d => 
                d.employe_id && normalizeId(d.employe_id) === normalizedSearchId
            );
            
            if (employeeData.length === 0) {
                return { reportData: [], grandTotal: "0.00", rawData: [] };
            }

            const weeklyReport = {};

            employeeData.forEach(entry => {
                if (!entry.timestamp) return;
                const [datePart, timePart] = entry.timestamp.split(' ');
                const dateKey = datePart; 
                const entryDateObject = new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                const weekKey = getWeekNumber(entryDateObject);

                if (!weeklyReport[weekKey]) {
                    weeklyReport[weekKey] = { totalHours: 0, days: {} };
                }
                
                const days = weeklyReport[weekKey].days;

                if (!days[dateKey]) {
                    days[dateKey] = { date: dateKey, dateObj: entryDateObject, arrivee: null, depart: null };
                }

                if (entry.action === 'Arrivee') {
                    if (!days[dateKey].arrivee || entryDateObject > days[dateKey].arrivee.timestamp) {
                        days[dateKey].arrivee = { timestamp: entryDateObject, time: timePart };
                    }
                } else if (entry.action === 'Depart') {
                    if (!days[dateKey].depart || entryDateObject > days[dateKey].depart.timestamp) {
                        days[dateKey].depart = { timestamp: entryDateObject, time: timePart };
                    }
                }
            });

            let finalReportData = [];
            
            for (const weekKey in weeklyReport) {
                let weeklyTotal = 0;
                const daysArray = Object.values(weeklyReport[weekKey].days).sort((a, b) => a.dateObj - b.dateObj);
                
                daysArray.forEach(day => {
                    let duration = 'N/A';
                    let decimalHours = 0;

                    if (day.arrivee && day.depart) {
                        const diffMs = day.depart.timestamp - day.arrivee.timestamp;
                        const diffHours = diffMs / (1000 * 60 * 60); 
                        
                        const hours = Math.floor(diffHours);
                        const minutes = Math.round((diffHours - hours) * 60);
                        
                        duration = `${hours}h ${String(minutes).padStart(2, '0')}min`;
                        decimalHours = parseFloat(diffHours.toFixed(2));
                        weeklyTotal += decimalHours;
                    }

                    finalReportData.push({
                        week: weekKey,
                        date: day.date,
                        arrivee: day.arrivee ? day.arrivee.time : '-',
                        depart: day.depart ? day.depart.time : '-',
                        duration: duration,
                        decimalHours: decimalHours.toFixed(2),
                        isWeeklyTotal: false
                    });
                });
                
                finalReportData.push({
                    week: weekKey,
                    isWeeklyTotal: true,
                    decimalHours: weeklyTotal.toFixed(2)
                });
            }
            
            const grandTotal = finalReportData
                .filter(item => item.isWeeklyTotal)
                .reduce((sum, item) => sum + parseFloat(item.decimalHours), 0)
                .toFixed(2);
                
            return { reportData: finalReportData, grandTotal: grandTotal, rawData: employeeData };
        }

        // ----------------------------------------------------
        // FONCTION D'AFFICHAGE BRUT (MODIFI√âE pour wrapper)
        // ----------------------------------------------------
        function getRawDataHtml(employeeData) {
            let html = '<div id="raw-data-section">'; 
            html += '<h3>D√©tail Brut des Pointages (Toutes les Lignes)</h3>';
            // Ajout du wrapper pour le d√©filement horizontal sur mobile
            html += '<div class="table-wrapper">'; 
            html += '<table class="raw-data-table"><thead><tr><th>Date & Heure</th><th>ID Employ√©</th><th>Action</th></tr></thead><tbody>';

            const sortedData = [...employeeData].sort((a, b) => {
                const dateA = new Date(a.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                const dateB = new Date(b.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                return dateB - dateA; 
            });

            sortedData.forEach(entry => {
                html += `<tr>
                            <td>${entry.timestamp || '-'}</td>
                            <td>${entry.employe_id || '-'}</td>
                            <td>${entry.action || '-'}</td>
                         </tr>`;
            });
            
            html += '</tbody></table>';
            html += '</div>'; // Fermeture du wrapper
            html += '</div>'; 
            return html;
        }

        // ----------------------------------------------------
        // FONCTION TOGGLE BRUT (Inchang√©e)
        // ----------------------------------------------------
        function toggleRawData() {
            const rawDataDiv = document.getElementById('raw-data-section');
            if (!rawDataDiv) return;

            if (rawDataDiv.style.display === 'none') {
                rawDataDiv.style.display = 'block';
                toggleButton.textContent = 'Masquer les donn√©es brutes';
            } else {
                rawDataDiv.style.display = 'none';
                toggleButton.textContent = 'Afficher les donn√©es brutes';
            }
        }

        // ----------------------------------------------------
        // 3. FONCTION DE SUPPRESSION DES DONN√âES (Inchang√©e)
        // ----------------------------------------------------
        async function deleteEmployeeData() {
            const employeeId = currentSearchId; 
            if (!employeeId) return;

            const confirmation = confirm(`√ätes-vous S√õR de vouloir SUPPRIMER TOUS les pointages pour l'employ√©: ${employeeId} ?\n\nCETTE ACTION EST IRR√âVERSIBLE !`);
            
            if (!confirmation) return;

            deleteButton.disabled = true;
            deleteButton.textContent = `Suppression en cours pour ${employeeId}...`;

            const queryUrl = `${API_URL}/employe_id/${employeeId}`; 

            try {
                const response = await fetch(queryUrl, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Succ√®s ! ${result.deleted || 'Toutes les lignes correspondantes'} ont √©t√© supprim√©es pour ${employeeId}.\n\nVeuillez recharger la page pour mettre √† jour les donn√©es.`);
                    
                    document.getElementById('report-output').innerHTML = '';
                    deleteButton.style.display = 'none';
                    document.getElementById('download-pdf').style.display = 'none';
                    toggleButton.style.display = 'none';
                    loadData(); 
                } else {
                    const errorText = await response.text();
                    alert(`‚ùå √âchec de la suppression pour ${employeeId}. Statut: ${response.status}. R√©ponse: ${errorText}`);
                }
            } catch (error) {
                alert(`‚ùå Erreur r√©seau lors de la suppression: ${error.message}`);
            } finally {
                deleteButton.disabled = false;
                deleteButton.textContent = '‚ö†Ô∏è SUPPRIMER TOUTES LES DONN√âES DE L\'EMPLOY√â (BASE DE DONN√âES)';
            }
        }


        // ----------------------------------------------------
        // 4. AFFICHAGE FINAL ET T√âL√âCHARGEMENT (MODIFI√âE pour wrapper)
        // ----------------------------------------------------
        function fetchAndCalculate() {
            const searchId = document.getElementById('search_id').value.trim();
            const output = document.getElementById('report-output');

            if (!searchId) {
                alert("Veuillez entrer un ID Employ√©.");
                return;
            }
            
            if (rawData.length === 0) {
                output.innerHTML = '<p style="color:var(--error-color);">Veuillez attendre le chargement des donn√©es ou v√©rifier votre connexion.</p>';
                return;
            }

            const { reportData: results, grandTotal, rawData: filteredRawData } = calculateHours(searchId); 
            
            currentSearchId = searchId; 
            finalReportData = results; 

            let html = `<h2>Rapport d'heures pour ${searchId}</h2>`;
            
            if (filteredRawData.length === 0) {
                html += '<p>Aucun pointage trouv√© pour cet ID.</p>';
                output.innerHTML = html;
                document.getElementById('download-pdf').style.display = 'none';
                toggleButton.style.display = 'none';
                deleteButton.style.display = 'none';
                return;
            }
            
            // 1. Affichage des donn√©es brutes
            html += getRawDataHtml(filteredRawData);

            // 2. Affichage du rapport calcul√© (synth√®se par jour/semaine)
            html += '<h2>Synth√®se des Heures Travaill√©es (Max par Jour)</h2>';

            let currentWeek = '';
            // Ajout du wrapper pour le d√©filement horizontal sur mobile
            html += '<div class="table-wrapper">'; 
            html += '<table><thead><tr><th>Date</th><th>Arriv√©e</th><th>D√©part</th><th>Dur√©e (H:M)</th><th>Heures D√©cimales</th></tr></thead><tbody>';
            
            results.forEach(item => {
                if (item.isWeeklyTotal) {
                    html += `<tr class="weekly-total">
                                <td colspan="4" style="text-align: right;">TOTAL SEMAINE ${item.week.split('-')[1]} :</td>
                                <td>${item.decimalHours} h</td>
                            </tr>`;
                } else {
                    if (item.week !== currentWeek) {
                        html += `<tr><td colspan="5"><h3 style="margin: 5px 0 0 0; padding: 5px 0; background-color: #f2f2f2; border: 1px solid #ddd;">SEMAINE ${item.week.split('-')[1]} (${item.week.split('-')[0]})</h3></td></tr>`;
                        currentWeek = item.week;
                    }
                    html += `<tr>
                                <td>${item.date}</td>
                                <td>${item.arrivee}</td>
                                <td>${item.depart}</td>
                                <td>${item.duration}</td>
                                <td>${item.decimalHours}</td>
                            </tr>`;
                }
            });
            
            html += `<tr class="grand-total">
                        <td colspan="4" style="text-align: right;">GRAND TOTAL P√âRIODE :</td>
                        <td>${grandTotal} h</td>
                    </tr>`;
            html += '</tbody></table>';
            html += '</div>'; // Fermeture du wrapper

            output.innerHTML = html;
            document.getElementById('download-pdf').style.display = 'block';
            toggleButton.style.display = 'inline-block';
            deleteButton.style.display = 'block';
            toggleButton.textContent = 'Masquer les donn√©es brutes';
        }

        // 5. G√©n√©ration PDF (Inchang√©e)
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const searchId = document.getElementById('search_id').value.trim();
            const now = new Date().toLocaleDateString('fr-FR');
            
            doc.text(`Rapport d√©taill√© des heures pour ${searchId}`, 14, 20);
            doc.text(`G√©n√©r√© le: ${now}`, 14, 26);

            let totalHours = 0;
            let currentY = 30;

            const groupedByWeek = finalReportData.reduce((acc, item) => {
                if (!item.week) return acc;
                if (!acc[item.week]) {
                    acc[item.week] = { days: [], total: 0 };
                }
                if (item.isWeeklyTotal) {
                    acc[item.week].total = parseFloat(item.decimalHours);
                    totalHours += parseFloat(item.decimalHours);
                } else {
                    acc[item.week].days.push([item.date, item.arrivee, item.depart, item.duration, item.decimalHours]);
                }
                return acc;
            }, {});

            const headers = [["Date", "Arriv√©e", "D√©part", "Dur√©e (H:M)", "Heures D√©cimales"]];

            for (const weekKey in groupedByWeek) {
                const year = weekKey.split('-')[0];
                const weekNum = weekKey.split('-')[1];

                if (currentY > 280) { 
                    doc.addPage();
                    currentY = 20;
                }
                doc.text(`SEMAINE ${weekNum} (${year})`, 14, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: headers,
                    body: groupedByWeek[weekKey].days,
                    foot: [['', '', '', 'TOTAL SEMAINE:', `${groupedByWeek[weekKey].total.toFixed(2)} h`]],
                    footStyles: { fontStyle: 'bold', fillColor: '#d1e7dd' },
                    didParseCell: function (data) {
                        if (data.section === 'foot') {
                             data.cell.colSpan = 5;
                             data.cell.styles.halign = 'right';
                        }
                    },
                    margin: { top: 10 },
                    theme: 'grid'
                });

                currentY = doc.lastAutoTable.finalY + 8;
            }
            
            if (currentY > 280) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(`GRAND TOTAL P√âRIODE: ${totalHours.toFixed(2)} h`, 14, currentY);

            doc.save(`Rapport_Semaines_${searchId}_${now.replace(/\//g, '-')}.pdf`);
        }
    </script>
</body>
</html>

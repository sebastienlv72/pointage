<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moteur de Recherche et Rapport d'Heures</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2a64c4; 
            --success-color: #4CAF50; 
            --error-color: #F44336;
            --text-color: #333;
            --bg-color: #f7f9fc;
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding: 20px;
        }
        .container {
            background-color: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px;
        }
        h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 20px; text-align: center; }
        h3 { color: var(--primary-color); padding: 5px 0; margin: 15px 0 5px 0; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; }
        button {
            padding: 10px 15px; border: none; border-radius: 6px;
            font-size: 1em; font-weight: bold; color: white; cursor: pointer;
            background-color: var(--primary-color); transition: background-color 0.2s;
        }
        button:hover:enabled { background-color: #1a4f9f; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        
        #loading-message { margin: 15px 0; font-weight: bold; color: var(--text-color); }
        
        /* Styles du Rapport */
        #report-output table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #report-output th, #report-output td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
        #report-output th { background-color: #f2f2f2; }
        .weekly-total { background-color: #d1e7dd; font-weight: bold; }
        .grand-total { background-color: #b8daff; font-weight: bold; }
        .raw-data-table th { background-color: #ffe0b2; }
        
        #download-pdf { background-color: var(--success-color); margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Moteur de Recherche d'Heures de Travail</h1>
        
        <div class="controls">
            <label for="search_id">ID Employ√©/Nom :</label>
            <input type="text" id="search_id" placeholder="Ex: S√©bastien">
            <button onclick="fetchAndCalculate()">Rechercher</button>
        </div>
        
        <div id="loading-message">Chargement des donn√©es...</div>
        <hr>
        
        <div id="report-output">
            </div>
        
        <button id="download-pdf" style="display:none;" onclick="generatePDF()">T√©l√©charger le PDF</button>
    </div>

    <script>
        // <<<< REMPLACER CETTE LIGNE PAR VOTRE VRAI LIEN SHEETDB >>>>
        const API_URL = 'https://sheetdb.io/api/v1/coc8f5iflpnxi'; 
        let rawData = []; 
        let reportData = []; 
        let finalReportData = []; // Donn√©es calcul√©es compl√®tes (pour le PDF)
        const searchButton = document.querySelector('button[onclick="fetchAndCalculate()"]');

        // ----------------------------------------------------
        // FONCTIONS UTILITAIRES
        // ----------------------------------------------------
        function normalizeId(text) {
            if (!text) return '';
            // Supprime les accents et convertit en minuscules
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + String(weekNo).padStart(2, '0');
        }

        // ----------------------------------------------------
        // 1. CHARGEMENT INITIAL DES DONN√âES
        // ----------------------------------------------------
        async function loadData() {
            searchButton.disabled = true;
            searchButton.textContent = "Chargement...";

            try {
                const response = await fetch(API_URL);
                rawData = await response.json();
                
                document.getElementById('loading-message').textContent = "‚úÖ Donn√©es charg√©es. Pr√™t √† rechercher.";
                
                searchButton.disabled = false;
                searchButton.textContent = "Rechercher";

            } catch (error) {
                document.getElementById('loading-message').textContent = `‚ùå Erreur de chargement des donn√©es. V√©rifiez votre URL API.`;
            }
        }
        loadData();

        // ----------------------------------------------------
        // 2. LOGIQUE DE CALCUL PAR JOUR ET PAR SEMAINE
        // ----------------------------------------------------
        function calculateHours(employeeId) {
            const normalizedSearchId = normalizeId(employeeId);
            
            // Filtrage : utilise l'ID normalis√© pour trouver TOUTES les correspondances
            const employeeData = rawData.filter(d => 
                d.employe_id && normalizeId(d.employe_id) === normalizedSearchId
            );
            
            if (employeeData.length === 0) {
                return { reportData: [], grandTotal: "0.00", rawData: [] };
            }

            const weeklyReport = {};

            employeeData.forEach(entry => {
                if (!entry.timestamp) return;

                const [datePart, timePart] = entry.timestamp.split(' ');
                const dateKey = datePart; 
                
                // Conversion du format FR (JJ/MM/AAAA) pour la cr√©ation de Date
                const entryDateObject = new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                
                const weekKey = getWeekNumber(entryDateObject);

                if (!weeklyReport[weekKey]) {
                    weeklyReport[weekKey] = { totalHours: 0, days: {} };
                }
                
                const days = weeklyReport[weekKey].days;

                if (!days[dateKey]) {
                    days[dateKey] = { 
                        date: dateKey, 
                        dateObj: entryDateObject,
                        arrivee: null, 
                        depart: null 
                    };
                }

                // Mettre √† jour l'heure la plus r√©cente (MAX) pour Arriv√©e et D√©part
                if (entry.action === 'Arrivee') {
                    if (!days[dateKey].arrivee || entryDateObject > days[dateKey].arrivee.timestamp) {
                        days[dateKey].arrivee = { timestamp: entryDateObject, time: timePart };
                    }
                } else if (entry.action === 'Depart') {
                    if (!days[dateKey].depart || entryDateObject > days[dateKey].depart.timestamp) {
                        days[dateKey].depart = { timestamp: entryDateObject, time: timePart };
                    }
                }
            });

            // 3. Calculer les totaux journaliers et hebdomadaires
            let finalReportData = [];
            
            for (const weekKey in weeklyReport) {
                let weeklyTotal = 0;
                const daysArray = Object.values(weeklyReport[weekKey].days).sort((a, b) => a.dateObj - b.dateObj);
                
                daysArray.forEach(day => {
                    let duration = 'N/A';
                    let decimalHours = 0;

                    if (day.arrivee && day.depart) {
                        const diffMs = day.depart.timestamp - day.arrivee.timestamp;
                        const diffHours = diffMs / (1000 * 60 * 60); 
                        
                        const hours = Math.floor(diffHours);
                        const minutes = Math.round((diffHours - hours) * 60);
                        
                        duration = `${hours}h ${String(minutes).padStart(2, '0')}min`;
                        decimalHours = parseFloat(diffHours.toFixed(2));
                        weeklyTotal += decimalHours;
                    }

                    finalReportData.push({
                        week: weekKey,
                        date: day.date,
                        arrivee: day.arrivee ? day.arrivee.time : '-',
                        depart: day.depart ? day.depart.time : '-',
                        duration: duration,
                        decimalHours: decimalHours.toFixed(2),
                        isWeeklyTotal: false
                    });
                });
                
                // Ajouter la ligne de total hebdomadaire
                finalReportData.push({
                    week: weekKey,
                    isWeeklyTotal: true,
                    decimalHours: weeklyTotal.toFixed(2)
                });
            }
            
            const grandTotal = finalReportData
                .filter(item => item.isWeeklyTotal)
                .reduce((sum, item) => sum + parseFloat(item.decimalHours), 0)
                .toFixed(2);
                
            return { reportData: finalReportData, grandTotal: grandTotal, rawData: employeeData };
        }

        // ----------------------------------------------------
        // FONCTION D'AFFICHAGE BRUT
        // ----------------------------------------------------
        function getRawDataHtml(employeeData) {
            let html = '<h3>D√©tail Brut des Pointages (Toutes les Lignes)</h3>';
            html += '<table class="raw-data-table"><thead><tr><th>Date & Heure</th><th>ID Employ√©</th><th>Action</th></tr></thead><tbody>';

            const sortedData = [...employeeData].sort((a, b) => {
                const dateA = new Date(a.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                const dateB = new Date

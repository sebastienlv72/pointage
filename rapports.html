<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moteur de Recherche et Rapport d'Heures</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2a64c4; 
            --success-color: #4CAF50; 
            --text-color: #333;
            --bg-color: #f7f9fc;
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding: 20px;
        }
        .container {
            background-color: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px;
        }
        h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 20px; text-align: center; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; }
        button {
            padding: 10px 15px; border: none; border-radius: 6px;
            font-size: 1em; font-weight: bold; color: white; cursor: pointer;
            background-color: var(--primary-color); transition: background-color 0.2s;
        }
        button:hover:enabled { background-color: #1a4f9f; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        
        #loading-message { margin: 15px 0; font-weight: bold; color: var(--text-color); }
        
        /* Styles du Rapport */
        #report-output h3 { 
            background-color: #e0e0e0; 
            padding: 10px; 
            margin-top: 25px; 
            margin-bottom: 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #report-output table { width: 100%; border-collapse: collapse; }
        #report-output th, #report-output td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
        #report-output th { background-color: #f2f2f2; }
        .weekly-total { background-color: #d1e7dd; font-weight: bold; }
        .grand-total { background-color: #b8daff; font-weight: bold; }
        
        #download-pdf { background-color: var(--success-color); margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Moteur de Recherche d'Heures de Travail</h1>
        
        <div class="controls">
            <label for="search_id">ID Employ√©/Nom :</label>
            <input type="text" id="search_id" placeholder="Ex: S√©bastien">
            <button onclick="fetchAndCalculate()">Rechercher</button>
        </div>
        
        <div id="loading-message">Chargement des donn√©es...</div>
        <hr>
        
        <div id="report-output">
            </div>
        
        <button id="download-pdf" style="display:none;" onclick="generatePDF()">T√©l√©charger le PDF</button>
    </div>

    <script>
        // <<<< REMPLACER CETTE LIGNE PAR VOTRE VRAI LIEN SHEETDB >>>>
        const API_URL = 'https://sheetdb.io/api/v1/coc8f5iflpnxi'; 
        let rawData = []; 
        let reportData = []; 
        const searchButton = document.querySelector('button[onclick="fetchAndCalculate()"]');

        // ----------------------------------------------------
        // FONCTION UTILITAIRE : CALCUL DU NUM√âRO DE SEMAINE ISO
        // ----------------------------------------------------
        function getWeekNumber(d) {
            // Clonez la date pour ne pas la modifier
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Mettre le d√©but de la semaine au jeudi (pour la norme ISO)
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Obtenir le premier jour de l'ann√©e
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculer le num√©ro de semaine
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + String(weekNo).padStart(2, '0');
        }

        // ----------------------------------------------------
        // 1. CHARGEMENT INITIAL DES DONN√âES
        // ----------------------------------------------------
        async function loadData() {
            searchButton.disabled = true;
            searchButton.textContent = "Chargement...";

            try {
                const response = await fetch(API_URL);
                rawData = await response.json();
                
                document.getElementById('loading-message').textContent = "‚úÖ Donn√©es charg√©es. Pr√™t √† rechercher.";
                
                searchButton.disabled = false;
                searchButton.textContent = "Rechercher";

            } catch (error) {
                document.getElementById('loading-message').textContent = `‚ùå Erreur de chargement des donn√©es. V√©rifiez votre URL API.`;
            }
        }
        loadData();

        // ----------------------------------------------------
        // 2. LOGIQUE DE CALCUL PAR JOUR ET PAR SEMAINE
        // ----------------------------------------------------
        function calculateHours(employeeId) {
            const employeeData = rawData.filter(d => d.employe_id && d.employe_id.toLowerCase() === employeeId.toLowerCase());
            
            const weeklyReport = {};

            employeeData.forEach(entry => {
                if (!entry.timestamp) return;

                const [datePart, timePart] = entry.timestamp.split(' ');
                const dateKey = datePart; 
                
                // Convertir le format FR en format Date JS pour les calculs (AAAA-MM-JJ)
                const entryDateObject = new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1 '));
                
                // Calculer la semaine
                const weekKey = getWeekNumber(entryDateObject);

                if (!weeklyReport[weekKey]) {
                    weeklyReport[weekKey] = { totalHours: 0, days: {} };
                }
                
                const days = weeklyReport[weekKey].days;

                if (!days[dateKey]) {
                    days[dateKey] = { 
                        date: dateKey, 
                        dateObj: entryDateObject,
                        arrivee: null, 
                        depart: null 
                    };
                }

                // Mettre √† jour l'heure la plus r√©cente (MAX) pour Arriv√©e et D√©part
                if (entry.action === 'Arrivee') {
                    if (!days[dateKey].arrivee || entryDateObject > days[dateKey].arrivee.timestamp) {
                        days[dateKey].arrivee = { timestamp: entryDateObject, time: timePart };
                    }
                } else if (entry.action === 'Depart') {
                    if (!days[dateKey].depart || entryDateObject > days[dateKey].depart.timestamp) {
                        days[dateKey].depart = { timestamp: entryDateObject, time: timePart };
                    }
                }
            });

            // 3. Calculer les totaux journaliers et hebdomadaires
            reportData = []; // R√©initialiser pour le PDF
            
            for (const weekKey in weeklyReport) {
                let weeklyTotal = 0;
                const daysArray = Object.values(weeklyReport[weekKey].days).sort((a, b) => a.dateObj - b.dateObj); // Trier les jours
                
                daysArray.forEach(day => {
                    let duration = 'N/A';
                    let decimalHours = 0;

                    if (day.arrivee && day.depart) {
                        const diffMs = day.depart.timestamp - day.arrivee.timestamp;
                        const diffHours = diffMs / (1000 * 60 * 60); 
                        
                        const hours = Math.floor(diffHours);
                        const minutes = Math.round((diffHours - hours) * 60);
                        
                        duration = `${hours}h ${String(minutes).padStart(2, '0')}min`;
                        decimalHours = parseFloat(diffHours.toFixed(2));
                        weeklyTotal += decimalHours;
                    }

                    // Stocker le rapport final dans un format plat pour l'affichage et le PDF
                    reportData.push({
                        week: weekKey,
                        date: day.date,
                        arrivee: day.arrivee ? day.arrivee.time : '-',
                        depart: day.depart ? day.depart.time : '-',
                        duration: duration,
                        decimalHours: decimalHours.toFixed(2),
                        isWeeklyTotal: false
                    });
                });
                
                // Ajouter la ligne de total hebdomadaire
                reportData.push({
                    week: weekKey,
                    isWeeklyTotal: true,
                    decimalHours: weeklyTotal.toFixed(2)
                });
                
                weeklyReport[weekKey].totalHours = weeklyTotal.toFixed(2);
            }
            
            // Calculer le grand total de la p√©riode
            const grandTotal = reportData
                .filter(item => item.isWeeklyTotal)
                .reduce((sum, item) => sum + parseFloat(item.decimalHours), 0)
                .toFixed(2);
                
            return { reportData, grandTotal };
        }

        // ----------------------------------------------------
        // 3. AFFICHAGE ET T√âL√âCHARGEMENT
        // ----------------------------------------------------
        function fetchAndCalculate() {
            const searchId = document.getElementById('search_id').value.trim();
            const output = document.getElementById('report-output');

            if (!searchId) {
                alert("Veuillez entrer un ID Employ√©.");
                return;
            }
            
            if (rawData.length === 0) {
                output.innerHTML = '<p style="color:var(--error-color);">Veuillez attendre le chargement des donn√©es ou v√©rifier votre connexion.</p>';
                return;
            }

            const { reportData: results, grandTotal } = calculateHours(searchId);
            
            let html = `<h2>Rapport d'heures pour ${searchId}</h2>`;
            
            if (results.length <= 1) { // 1 pour la ligne de grand total s'il n'y a qu'une ligne
                html += '<p>Aucun pointage trouv√© pour cet ID.</p>';
                output.innerHTML = html;
                document.getElementById('download-pdf').style.display = 'none';
                return;
            }

            let currentWeek = '';
            html += '<table><thead><tr><th>Date</th><th>Arriv√©e</th><th>D√©part</th><th>Dur√©e (H:M)</th><th>Heures D√©cimales</th></tr></thead><tbody>';
            
            results.forEach(item => {
                if (item.isWeeklyTotal) {
                    // Ligne Total Hebdomadaire
                    html += `<tr class="weekly-total">
                                <td colspan="4" style="text-align: right;">TOTAL SEMAINE ${item.week.split('-')[1]} :</td>
                                <td>${item.decimalHours} h</td>
                            </tr>`;
                } else {
                    // Si c'est un nouveau num√©ro de semaine, ajouter un titre
                    if (item.week !== currentWeek) {
                        html += `<tr><td colspan="5"><h3>SEMAINE ${item.week.split('-')[1]} (${item.week.split('-')[0]})</h3></td></tr>`;
                        currentWeek = item.week;
                    }
                    // Ligne Jour
                    html += `<tr>
                                <td>${item.date}</td>
                                <td>${item.arrivee}</td>
                                <td>${item.depart}</td>
                                <td>${item.duration}</td>
                                <td>${item.decimalHours}</td>
                            </tr>`;
                }
            });
            
            // Afficher le Grand Total
            html += `<tr class="grand-total">
                        <td colspan="4" style="text-align: right;">GRAND TOTAL P√âRIODE :</td>
                        <td>${grandTotal} h</td>
                    </tr>`;
            html += '</tbody></table>';

            output.innerHTML = html;
            document.getElementById('download-pdf').style.display = 'block';
        }

        // 4. G√©n√©ration PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const searchId = document.getElementById('search_id').value.trim();
            const now = new Date().toLocaleDateString('fr-FR');
            
            doc.text(`Rapport d√©taill√© des heures pour ${searchId}`, 14, 20);
            doc.text(`G√©n√©r√© le: ${now}`, 14, 26);

            let finalTableData = [];
            let totalHours = 0;
            let currentY = 30; // Position de d√©part

            // Filtrer et structurer les donn√©es pour le PDF
            const groupedByWeek = reportData.reduce((acc, item) => {
                if (!item.week) return acc;
                if (!acc[item.week]) {
                    acc[item.week] = { days: [], total: 0 };
                }
                if (item.isWeeklyTotal) {
                    acc[item.week].total = parseFloat(item.decimalHours);
                    totalHours += parseFloat(item.decimalHours);
                } else {
                    acc[item.week].days.push([item.date, item.arrivee, item.depart, item.duration, item.decimalHours]);
                }
                return acc;
            }, {});

            const headers = [["Date", "Arriv√©e", "D√©part", "Dur√©e (H:M)", "Heures D√©cimales"]];

            for (const weekKey in groupedByWeek) {
                const year = weekKey.split('-')[0];
                const weekNum = weekKey.split('-')[1];

                // Ajouter le titre de la semaine
                doc.text(`SEMAINE ${weekNum} (${year})`, 14, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: headers,
                    body: groupedByWeek[weekKey].days,
                    foot: [['', '', '', 'TOTAL SEMAINE:', `${groupedByWeek[weekKey].total.toFixed(2)} h`]],
                    footStyles: { fontStyle: 'bold', fillColor: '#d1e7dd' },
                    didParseCell: function (data) {
                        // Pour que les totaux hebdomadaires ne soient pas coup√©s
                        if (data.section === 'foot') {
                             data.cell.colSpan = 5;
                             data.cell.styles.halign = 'right';
                        }
                    },
                    margin: { top: 10 },
                    theme: 'grid'
                });

                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Ajouter le Grand Total √† la fin
            doc.text(`GRAND TOTAL P√âRIODE: ${totalHours.toFixed(2)} h`, 14, currentY);

            doc.save(`Rapport_Semaines_${searchId}_${now.replace(/\//g, '-')}.pdf`);
        }
    </script>
</body>
</html>

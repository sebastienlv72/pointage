<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pointage Airtable Mobile</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;color:#222;padding:12px;text-align:center;}
section{background:#fff;border-radius:10px;padding:16px;margin:12px 0;box-shadow:0 3px 10px rgba(0,0,0,0.06);}
select,input,button{padding:14px;margin:8px 0;font-size:16px;border-radius:8px;border:1px solid #d4d7dd;width:100%;box-sizing:border-box;}
button{background:#2f6fff;color:#fff;border:none;cursor:pointer;font-weight:600;}
button[disabled]{opacity:0.6;cursor:not-allowed;}
.danger{background:#ff5a5a;}
.pointage-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f0f2f5;font-size:14px;}
#pointages{max-height:250px;overflow-y:auto;}
#status{margin-top:10px;font-weight:600;font-size:15px;}
</style>
</head>
<body>

<h1>Pointage Airtable Mobile</h1>

<section>
<h3>Employ√©s</h3>
<select id="employeeSelect" onchange="onEmployeeChange()"><option>Chargement...</option></select>
<div>
<input id="newEmployee" placeholder="Nouveau nom" />
<button id="addBtn" onclick="addEmployee()">‚ûï Ajouter</button>
</div>
</section>

<section>
<h3>Pointage</h3>
<div>
<button id="inBtn" onclick="punch('IN')">Entr√©e</button>
<button id="outBtn" onclick="punch('OUT')">Sortie</button>
</div>
<p id="status">Statut : pr√™t</p>
</section>

<section>
<h3>Filtrer</h3>
<label>Du <input type="date" id="startDate" /></label>
<label>Au <input type="date" id="endDate" /></label>
<button onclick="filterByDate()">Appliquer filtre</button>
<button onclick="clearFilter()">R√©initialiser filtre</button>
</section>

<section>
<h3>Historique</h3>
<div id="pointages">Chargement...</div>
<h4>Total travaill√© : <span id="totalTime">0h 0m</span></h4>
<button onclick="exportPDF()">üì© Envoyer par email (PDF)</button>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* CONFIGURATION Airtable */
const AIRTABLE_BASE_ID="appOcHv2PEis68ttI"; 
const AIRTABLE_TOKEN="patavl975YpJzd6UH.28e5ca63db2706bfe435425f9867da23e42e8c35293789c5da7bce1ee8f10e7c";
const EMPLOYES_TABLE="employes";
const POINTAGES_TABLE="pointages";
const EMPLOYES_URL=`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(EMPLOYES_TABLE)}`;
const POINTAGES_URL=`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(POINTAGES_TABLE)}`;

/* UTILITAIRES */
function setStatus(msg,err=false){const el=document.getElementById('status');el.textContent=`Statut : ${msg}`;el.style.color=err?'red':'green';}
function getUUID(name){return 'web-'+name+'-'+navigator.userAgent.split('').map(c=>c.charCodeAt(0).toString(36)).join('').slice(0,6);}

/* ===== CHARGER EMPLOY√âS ===== */
async function loadEmployees(selectUuid=null){
  const sel=document.getElementById('employeeSelect'); sel.innerHTML='<option>Chargement...</option>';
  try{
    const res=await fetch(EMPLOYES_URL,{headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
    const data=await res.json();
    sel.innerHTML='<option value="">-- S√©lectionner un employ√© --</option>';
    data.records.forEach(r=>{
      const name=r.fields.NomComplet||'Sans nom';
      const uuid=r.fields.UUID||r.id;
      const opt=document.createElement('option'); opt.value=uuid; opt.textContent=name; sel.appendChild(opt);
    });
    if(selectUuid) sel.value=selectUuid;
    setStatus('Employ√©s charg√©s');
    if(sel.value) loadPointages(sel.value);
  }catch(e){console.error(e); setStatus('Erreur chargement employ√©s',true);}
}

/* ===== AJOUT EMPLOY√â ===== */
async function addEmployee(){
  const name=document.getElementById('newEmployee').value.trim(); if(!name)return alert('Saisir un nom');
  const uuid=getUUID(name); document.getElementById('addBtn').disabled=true; setStatus('Ajout en cours...');
  try{
    const res=await fetch(EMPLOYES_URL,{method:'POST',headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({records:[{fields:{NomComplet:name,UUID:uuid}}]})});
    const data=await res.json(); if(!res.ok) throw new Error(data.error?.message);
    document.getElementById('newEmployee').value=''; setStatus('Employ√© ajout√©'); await loadEmployees(uuid);
  }catch(e){console.error(e); alert('Erreur ajout employ√© : '+e.message);}finally{document.getElementById('addBtn').disabled=false;}
}

/* ===== POINTAGE ===== */
async function punch(type){
  const sel=document.getElementById('employeeSelect'); const uuid=sel.value; const name=sel.options[sel.selectedIndex].text;
  if(!uuid) return alert('S√©lectionner un employ√©');
  document.getElementById('inBtn').disabled=document.getElementById('outBtn').disabled=true;
  setStatus(`${type} en cours...`);
  const now=new Date(); const heure=now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}); const dateIso=now.toISOString().split('T')[0];
  try{
    const res=await fetch(POINTAGES_URL,{method:'POST',headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({records:[{fields:{UUID:uuid,NomComplet:name,TypeAction:type,Heure:heure,Date:dateIso}}]})});
    const data=await res.json(); if(!res.ok) throw new Error(data.error?.message);
    setStatus(`${name} a point√© ${type} √† ${heure}`); await loadPointages(uuid);
  }catch(e){console.error(e); setStatus('Erreur de pointage : '+e.message,true);}finally{document.getElementById('inBtn').disabled=document.getElementById('outBtn').disabled=false;}
}

/* ===== CHARGER POINTAGES ===== */
let lastRecords=[];
async function loadPointages(uuid,start=null,end=null){
  const cont=document.getElementById('pointages'); cont.textContent='Chargement...'; setStatus('Chargement pointages...');
  try{
    const formula=encodeURIComponent(`{UUID}='${uuid}'`);
    const res=await fetch(`${POINTAGES_URL}?filterByFormula=${formula}&sort[0][field]=Date&sort[0][direction]=asc`,{headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
    const data=await res.json(); if(!res.ok) throw new Error(data.error?.message); lastRecords=data.records||[];
    cont.innerHTML=''; let total=0,lastIn=null;
    lastRecords.forEach(r=>{
      const f=r.fields; const t=(f.Heure||'00:00').split(':').map(Number); const mins=t[0]*60+t[1];
      if(f.TypeAction==='IN') lastIn=mins; else if(f.TypeAction==='OUT'&&lastIn!==null){total+=mins-lastIn;lastIn=null;}
      const div=document.createElement('div'); div.className='pointage-item';
      div.textContent=`${f.Date||''} ${f.Heure||''} (${f.TypeAction})`; cont.appendChild(div);
    });
    const h=Math.floor(total/60),m=total%60; document.getElementById('totalTime').textContent=`${h}h ${m}m`; setStatus('Pointages charg√©s');
  }catch(e){console.error(e); cont.textContent='Erreur chargement pointages'; setStatus('Erreur pointages : '+e.message,true);}
}

/* ===== FILTRES ===== */
function filterByDate(){const start=document.getElementById('startDate').value,end=document.getElementById('endDate').value,uuid=document.getElementById('employeeSelect').value;if(!uuid)return alert('S√©lectionner un employ√©'); loadPointages(uuid,start,end);}
function clearFilter(){document.getElementById('startDate').value='';document.getElementById('endDate').value=''; const uuid=document.getElementById('employeeSelect').value; if(uuid)loadPointages(uuid);}

/* ===== EXPORT PDF ===== */
async function exportPDF(){
  const { jsPDF } = window.jspdf; const doc=new jsPDF();
  const sel=document.getElementById('employeeSelect'); const name=sel.options[sel.selectedIndex]?.text||'Employ√©';
  doc.setFontSize(16); doc.text(`Historique pointages - ${name}`,10,20);
  let y=30;
  lastRecords.forEach(r=>{
    const f=r.fields;
    doc.text(`${f.Date||''} ${f.Heure||''} (${f.TypeAction})`,10,y);
    y+=8;
  });
  doc.text(`Total travaill√© : ${document.getElementById('totalTime').textContent}`,10,y+5);
  doc.save(`${name}-pointages.pdf`);
  alert('PDF g√©n√©r√©, tu peux maintenant l‚Äôenvoyer par email manuellement.');
}

/* ===== INIT ===== */
loadEmployees();
</script>
</body>
</html>

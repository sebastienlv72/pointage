<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pointage Airtable - Version Avanc√©e</title>
<style>
body { font-family: Arial, sans-serif; background: #f8fafc; color: #333; text-align: center; padding: 20px; }
h1 { color: #222; margin-bottom: 20px; }
select, input, button { padding: 10px; margin: 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: 600; }
button:hover { background-color: #0056b3; }
#status { margin-top: 10px; font-weight: bold; color: #444; }
.pointage-item { margin: 4px 0; }
.pointage-item button { background-color: #ff4d4d; margin-left: 10px; }
.pointage-item button:hover { background-color: #d93636; }
section { background: #fff; padding: 15px; border-radius: 10px; max-width: 600px; margin: 0 auto 20px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h1>üïí Gestion du Pointage - Airtable</h1>

<section>
  <h3>üë§ S√©lection de l‚Äôemploy√©</h3>
  <select id="employeeSelect" onchange="onEmployeeChange()">
    <option value="">Chargement...</option>
  </select><br>
  <input type="text" id="newEmployee" placeholder="Ajouter un employ√©">
  <button onclick="addEmployee()">‚ûï Ajouter</button>
</section>

<section>
  <h3>üìÖ Pointage</h3>
  <button onclick="punch('IN')">Entr√©e</button>
  <button onclick="punch('OUT')">Sortie</button>
  <p id="status">‚è≥ En attente...</p>
</section>

<section>
  <h3>üîç Rechercher par p√©riode</h3>
  <label>Du :</label> <input type="date" id="startDate">
  <label>Au :</label> <input type="date" id="endDate">
  <button onclick="filterByDate()">Filtrer</button>
</section>

<section>
  <h3>üìú Historique</h3>
  <div id="pointages">Chargement...</div>
  <h3>Total travaill√© : <span id="totalTime">0h 0m</span></h3>
</section>

<script>
/* === CONFIGURATION AIRTABLE === */
const AIRTABLE_BASE_ID = "appOcHv2PEis68ttI";  // ‚ö†Ô∏è √† remplacer
const AIRTABLE_TOKEN = "patavl975YpJzd6UH.28e5ca63db2706bfe435425f9867da23e42e8c35293789c5da7bce1ee8f10e7c";    // ‚ö†Ô∏è ton token Airtable
const EMPLOYES_TABLE = "employes";
const POINTAGES_TABLE = "pointages";

const EMPLOYES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${EMPLOYES_TABLE}`;
const POINTAGES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${POINTAGES_TABLE}`;

/* === FONCTIONS UTILES === */
function generateUUID() {
  return 'xxxxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function formatDate(d) {
  return new Date(d).toLocaleDateString('fr-FR');
}

/* === CHARGEMENT DES EMPLOY√âS === */
async function loadEmployees() {
  const select = document.getElementById("employeeSelect");
  select.innerHTML = "<option>Chargement...</option>";

  try {
    const res = await fetch(EMPLOYES_URL, {
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });
    const data = await res.json();
    select.innerHTML = '<option value="">-- Choisir un employ√© --</option>';
    data.records.forEach(emp => {
      const opt = document.createElement("option");
      opt.value = emp.fields.UUID;
      opt.text = emp.fields.NomComplet;
      select.appendChild(opt);
    });
    document.getElementById("status").textContent = "‚úÖ Employ√©s charg√©s";
  } catch (err) {
    document.getElementById("status").textContent = "‚ùå Erreur chargement employ√©s";
  }
}

/* === CHANGEMENT EMPLOY√â === */
function onEmployeeChange() {
  const uuid = document.getElementById("employeeSelect").value;
  if (!uuid) {
    document.getElementById("pointages").innerHTML = "";
    document.getElementById("totalTime").textContent = "0h 0m";
    return;
  }
  loadPointages(uuid);
}

/* === AJOUT EMPLOY√â === */
async function addEmployee() {
  const name = document.getElementById("newEmployee").value.trim();
  if (!name) return alert("Veuillez entrer un nom !");
  const uuid = generateUUID();

  try {
    const res = await fetch(EMPLOYES_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ records: [{ fields: { NomComplet: name, UUID: uuid } }] })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    document.getElementById("status").textContent = `‚úÖ Employ√© ${name} ajout√©`;
    document.getElementById("newEmployee").value = "";
    loadEmployees();
  } catch (e) {
    document.getElementById("status").textContent = "‚ùå Erreur ajout employ√©";
  }
}

/* === POINTAGE === */
async function punch(type) {
  const select = document.getElementById("employeeSelect");
  const uuid = select.value;
  const name = select.options[select.selectedIndex]?.text;

  if (!uuid) return alert("S√©lectionnez un employ√© !");
  const now = new Date();
  const heure = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const date = now.toISOString().split("T")[0]; // format AAAA-MM-JJ

  try {
    const res = await fetch(POINTAGES_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        records: [{ fields: { UUID: uuid, NomComplet: name, TypeAction: type, Heure: heure, Date: date } }]
      })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    document.getElementById("status").textContent = `‚úÖ ${name} a point√© ${type} √† ${heure}`;
    loadPointages(uuid);
  } catch (e) {
    document.getElementById("status").textContent = "‚ùå Erreur pointage";
  }
}

/* === CHARGER LES POINTAGES === */
async function loadPointages(uuid, start = null, end = null) {
  const container = document.getElementById("pointages");
  container.innerHTML = "Chargement...";
  let filter = `filterByFormula={UUID}='${uuid}'`;

  if (start && end) {
    filter += `AND(IS_AFTER({Date}, '${start}'), IS_BEFORE({Date}, '${end}'))`;
  }

  try {
    const res = await fetch(`${POINTAGES_URL}?${filter}&sort[0][field]=Date&sort[0][direction]=asc`, {
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });
    const data = await res.json();

    container.innerHTML = "";
    if (!data.records.length) {
      container.innerHTML = "<p>Aucun pointage</p>";
      document.getElementById("totalTime").textContent = "0h 0m";
      return;
    }

    let total = 0, lastIn = null;
    data.records.forEach(r => {
      const f = r.fields;
      const [h, m] = f.Heure.split(':').map(Number);
      const t = h * 60 + m;

      if (f.TypeAction === "IN") lastIn = t;
      if (f.TypeAction === "OUT" && lastIn !== null) {
        total += (t - lastIn);
        lastIn = null;
      }

      const div = document.createElement("div");
      div.className = "pointage-item";
      div.innerHTML = `${formatDate(f.Date)} - ${f.Heure} (${f.TypeAction}) <button onclick="deletePointage('${r.id}', '${uuid}')">Supprimer</button>`;
      container.appendChild(div);
    });

    const h = Math.floor(total / 60);
    const m = total % 60;
    document.getElementById("totalTime").textContent = `${h}h ${m}m`;
  } catch (e) {
    container.innerHTML = "<p>‚ùå Erreur chargement</p>";
  }
}

/* === SUPPRESSION POINTAGE === */
async function deletePointage(id, uuid) {
  if (!confirm("Supprimer ce pointage ?")) return;
  try {
    const res = await fetch(`${POINTAGES_URL}/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    loadPointages(uuid);
  } catch (e) {
    alert("‚ùå Erreur suppression");
  }
}

/* === FILTRER PAR DATE === */
function filterByDate() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const uuid = document.getElementById("employeeSelect").value;
  if (!uuid) return alert("Choisissez un employ√© !");
  if (!start || !end) return alert("Choisissez les deux dates !");
  loadPointages(uuid, start, end);
}

/* === INIT === */
loadEmployees();
</script>
</body>
</html>

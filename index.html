<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pointage Airtable avec employés dynamiques</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
h1 { color: #333; margin-bottom: 20px; }
select, input, button { padding: 10px; margin: 10px 0; font-size: 16px; border-radius: 6px; }
button { cursor: pointer; background-color: #375aff; color: white; border: none; }
button:hover { background-color: #003bff; }
#status { margin-top: 15px; color: #555; font-weight: bold; }
.pointage-item { margin: 5px 0; }
.pointage-item button { background-color: #ff4d4d; margin-left: 10px; }
.pointage-item button:hover { background-color: #cc0000; }
</style>
</head>
<body>

<h1>Pointage des employés</h1>

<div>
    <label>Choisir un employé :</label><br>
    <select id="employeeSelect" onchange="loadPointages()">
        <option value="">Chargement...</option>
    </select>
</div>

<div>
    <input type="text" id="newEmployee" placeholder="Ajouter un nouvel employé">
    <button onclick="addEmployee()">Ajouter</button>
</div>

<div>
    <button onclick="punch('IN')">Pointer Entrée</button>
    <button onclick="punch('OUT')">Pointer Sortie</button>
</div>

<h3>Historique des pointages :</h3>
<div id="pointages"></div>

<h3>Temps total travaillé : <span id="totalTime">0h 0m</span></h3>

<p id="status">Statut : prêt</p>

<script>
const AIRTABLE_BASE_ID = "appOcHv2PEis68ttI"; // ⚠️ Ton Base ID
const AIRTABLE_TOKEN = "patavl975YpJzd6UH.1e9444c453c0eb30065fe4c32b5574152fa0dcc53d7d6c38292f6bccf35d535b";    // ⚠️ Ton token
const EMPLOYES_TABLE = "employes";
const POINTAGES_TABLE = "pointages";
const EMPLOYES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${EMPLOYES_TABLE}`;
const POINTAGES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${POINTAGES_TABLE}`;

// ✅ Générer un UUID unique
function generateUUID() {
  return 'xxxxxx-xxxx-4xxx-yxxx-xxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
  });
}

// ✅ Charger la liste des employés
async function loadEmployees() {
  try {
    const res = await fetch(EMPLOYES_URL, {
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });
    const data = await res.json();

    const select = document.getElementById('employeeSelect');
    select.innerHTML = '';

    if (!data.records || data.records.length === 0) {
      select.innerHTML = `<option value="">Aucun employé</option>`;
      return;
    }

    data.records.forEach(emp => {
      const opt = document.createElement('option');
      opt.value = emp.fields.NomComplet; // Le nom du champ dans ta table
      opt.text = emp.fields.NomComplet;
      select.appendChild(opt);
    });

    loadPointages();
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "❌ Erreur lors du chargement des employés.";
  }
}

// ✅ Ajouter un nouvel employé
async function addEmployee() {
  const name = document.getElementById('newEmployee').value.trim();
  if (!name) { alert("Entrez un nom d'employé"); return; }

  const uuid = generateUUID();

  try {
    const res = await fetch(EMPLOYES_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        records: [{
          fields: { NomComplet: name, UUID: uuid }
        }]
      })
    });

    if (!res.ok) {
      throw new Error(`Erreur HTTP ${res.status}`);
    }

    document.getElementById('status').innerText = `✅ Employé "${name}" ajouté`;
    document.getElementById('newEmployee').value = "";
    loadEmployees();
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "❌ Erreur lors de l'ajout de l'employé";
  }
}

// ✅ Pointer IN / OUT
async function punch(type) {
  const emp = document.getElementById('employeeSelect').value;
  if (!emp) { alert("Sélectionnez un employé"); return; }

  const now = new Date();
  const heure = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('fr-FR');
  const uuid = generateUUID();

  try {
    const res = await fetch(POINTAGES_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        records: [{
          fields: { NomComplet: emp, TypeAction: type, Heure: heure, Date: date, UUID: uuid }
        }]
      })
    });

    if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);

    document.getElementById('status').innerText = `✅ ${emp} a pointé ${type} à ${heure}`;
    loadPointages();
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "❌ Erreur de pointage";
  }
}

// ✅ Charger les pointages
async function loadPointages() {
  const emp = document.getElementById('employeeSelect').value;
  if (!emp) return;

  try {
    const res = await fetch(`${POINTAGES_URL}?filterByFormula={NomComplet}='${emp}'&sort[0][field]=Date&sort[0][direction]=asc`, {
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });

    const data = await res.json();
    const container = document.getElementById('pointages');
    container.innerHTML = '';

    if (!data.records || data.records.length === 0) {
      container.innerHTML = "<p>Aucun pointage</p>";
      document.getElementById('totalTime').innerText = "0h 0m";
      return;
    }

    let totalMinutes = 0, lastIn = null;

    data.records.forEach(rec => {
      const div = document.createElement('div');
      div.className = "pointage-item";
      div.innerHTML = `${rec.fields.Date} ${rec.fields.Heure} (${rec.fields.TypeAction}) 
      <button onclick="deletePointage('${rec.id}')">Supprimer</button>`;
      container.appendChild(div);

      const [h, m] = rec.fields.Heure.split(':').map(Number);
      if (rec.fields.TypeAction === "IN") lastIn = h * 60 + m;
      if (rec.fields.TypeAction === "OUT" && lastIn !== null) {
        totalMinutes += (h * 60 + m) - lastIn;
        lastIn = null;
      }
    });

    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('totalTime').innerText = `${hours}h ${minutes}m`;
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "❌ Erreur lors du chargement des pointages";
  }
}

// ✅ Supprimer un pointage
async function deletePointage(recordId) {
  if (!confirm("Supprimer ce pointage ?")) return;

  try {
    const res = await fetch(`${POINTAGES_URL}/${recordId}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });

    if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
    loadPointages();
  } catch (e) {
    console.error(e);
    alert("❌ Erreur lors de la suppression");
  }
}

loadEmployees();
</script>

</body>
</html>

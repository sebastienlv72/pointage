<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pointage & Temps de Travail (Airtable)</title>
<style>
body { font-family:'Inter',sans-serif; text-align:center; padding:20px; background:#f4f4f9; }
#formContainer {background:#fff; max-width:400px; margin:20px auto; padding:25px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
input, button {padding:10px; margin:10px 0; width:100%; border-radius:8px; border:1px solid #ddd; font-size:16px;}
button {cursor:pointer; background:#3b5bff; color:#fff; font-weight:600; border:none;}
button:hover {background:#2a4ae3;}
#status, #result {margin-top:15px; font-weight:500;}
</style>
</head>
<body>

<h1>Pointage & Temps de Travail (Airtable)</h1>

<div id="formContainer">
  <input type="text" id="airtableApiKey" placeholder="Clé API Airtable" required>
  <input type="text" id="airtableBaseId" placeholder="ID Base Airtable" required>
  <input type="text" id="tableName" placeholder="Nom de la table" required>
  <input type="text" id="name" placeholder="Votre nom complet" required>
  <button id="punchIn">Pointer Entrée</button>
  <button id="punchOut">Pointer Sortie</button>
  <button id="calculate">Calculer temps de travail</button>
  <button id="generatePDF">Télécharger PDF</button>
</div>

<div id="status">Statut : En attente...</div>
<div id="result"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const uuid = localStorage.getItem("punch_uuid") || generateUUID();
let totalWorkTime = null;

function generateUUID() {
  const id = 'web-' + Date.now().toString(36) + Math.random().toString(36).substr(2,6);
  localStorage.setItem("punch_uuid", id);
  return id;
}

function getAirtableUrl() {
  const baseId = document.getElementById("airtableBaseId").value.trim();
  const tableName = document.getElementById("tableName").value.trim();
  if(!baseId || !tableName) throw new Error("Base ID ou nom de table manquant");
  return `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}`;
}

async function postPunch(type) {
  const apiKey = document.getElementById("airtableApiKey").value.trim();
  const name = document.getElementById("name").value.trim();
  if(!apiKey || !name) { alert("Remplissez tous les champs"); return; }

  const payload = {
    fields: {
      UUID: uuid,
      NomComplet: name,
      TypeAction: type,
      Date: new Date().toLocaleDateString('fr-FR'),
      Heure: new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})
    }
  };

  try {
    document.getElementById("status").textContent = "⏳ Enregistrement...";
    const res = await fetch(getAirtableUrl(),{
      method:"POST",
      headers:{
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type":"application/json"
      },
      body: JSON.stringify(payload)
    });
    document.getElementById("status").textContent = res.ok ? `✅ ${type} enregistrée` : `❌ Erreur HTTP ${res.status}`;
  } catch(err){
    document.getElementById("status").textContent = "❌ Erreur : "+err.message;
  }
}

function parseTime(str){
  const [h,m] = str.split(":").map(Number);
  return h*60 + m;
}

function formatDuration(totalMinutes){
  const h = Math.floor(totalMinutes/60);
  const m = totalMinutes%60;
  return `${h}h ${m}m`;
}

async function calculateTime() {
  const status = document.getElementById("status");
  const result = document.getElementById("result");
  status.textContent = "⏳ Calcul en cours...";
  result.textContent = "";

  const apiKey = document.getElementById("airtableApiKey").value.trim();
  if(!apiKey){ status.textContent="❌ Clé API manquante"; return; }

  try {
    const url = getAirtableUrl() + `?filterByFormula={UUID}='${uuid}'&sort[0][field]=Date&sort[0][direction]=asc`;
    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${apiKey}` }
    });
    if(!res.ok) throw new Error("Erreur HTTP "+res.status);
    const data = (await res.json()).records;
    if(data.length===0){ status.textContent="❌ Aucun pointage trouvé"; return null; }

    let total = 0, lastIN=null;
    data.forEach(r=>{
      const fields = r.fields;
      if(fields.TypeAction==="PointageIN") lastIN = fields.Heure;
      else if(fields.TypeAction==="PointageOUT" && lastIN){
        total += parseTime(fields.Heure)-parseTime(lastIN);
        lastIN=null;
      }
    });

    totalWorkTime = formatDuration(total);
    status.textContent="✅ Temps total calculé :";
    result.textContent=totalWorkTime;
    return totalWorkTime;

  } catch(err){
    status.textContent="❌ Erreur : "+err.message;
    return null;
  }
}

function generatePDF() {
  if(!totalWorkTime) { alert("Calculer le temps de travail d'abord"); return; }
  const name = document.getElementById("name").value.trim();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Rapport de pointage`, 10, 20);
  doc.text(`Nom: ${name}`, 10, 30);
  doc.text(`UUID: ${uuid}`, 10, 40);
  doc.text(`Temps total travaillé: ${totalWorkTime}`, 10, 50);
  doc.save(`Pointage_${name}.pdf`);
}

// Événements
document.getElementById("punchIn").addEventListener("click", ()=>postPunch("PointageIN"));
document.getElementById("punchOut").addEventListener("click", ()=>postPunch("PointageOUT"));
document.getElementById("calculate").addEventListener("click", calculateTime);
document.getElementById("generatePDF").addEventListener("click", generatePDF);
</script>

</body>
</html>

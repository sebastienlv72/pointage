<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pointage Airtable avec employés dynamiques</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
h1 { color: #333; margin-bottom: 20px; }
select, input, button { padding: 10px; margin: 10px 0; font-size: 16px; border-radius: 6px; }
button { cursor: pointer; background-color: #375aff; color: white; border: none; }
button:hover { background-color: #003bff; }
#status { margin-top: 15px; color: #555; font-weight: bold; }
.pointage-item { margin: 5px 0; }
.pointage-item button { background-color: #ff4d4d; margin-left: 10px; }
.pointage-item button:hover { background-color: #cc0000; }
</style>
</head>
<body>

<h1>Pointage des employés</h1>

<div>
    <label>Choisir un employé :</label><br>
    <select id="employeeSelect" onchange="loadPointages()">
        <option value="">Chargement...</option>
    </select>
</div>

<div>
    <input type="text" id="newEmployee" placeholder="Ajouter nouvel employé">
    <button onclick="addEmployee()">Ajouter</button>
</div>

<div>
    <button onclick="punch('IN')">Pointer Entrée</button>
    <button onclick="punch('OUT')">Pointer Sortie</button>
</div>

<h3>Historique des pointages :</h3>
<div id="pointages"></div>

<h3>Temps total travaillé : <span id="totalTime">0h 0m</span></h3>

<p id="status">Statut : prêt</p>

<script>
const AIRTABLE_BASE_ID = "appOcHv2PEis68ttI"; // Remplace par ton Base ID
const AIRTABLE_TOKEN = "patavl975YpJzd6UH.4b4218f1643c269ea11b7350807b31a427d70ad9a1a54b674d73fa5c9ffe9657";    // Remplace par ton Token Airtable
const EMPLOYES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/employes`;
const POINTAGES_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/pointages`;

// Générer UUID
function generateUUID() {
    return 'xxxxxx-xxxx-4xxx-yxxx-xxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Charger la liste des employés depuis Airtable
async function loadEmployees() {
    try {
        const res = await fetch(EMPLOYES_URL, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
        const data = await res.json();
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '';
        data.records.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.fields.NomTable;
            option.text = emp.fields.NomAffiche;
            select.appendChild(option);
        });
        loadPointages();
    } catch(e) {
        console.error(e);
        alert("Erreur chargement employés");
    }
}

// Ajouter un nouvel employé dans Airtable
async function addEmployee() {
    const newEmp = document.getElementById('newEmployee').value.trim();
    if(!newEmp) { alert("Entrez un nom"); return; }
    const nomTable = newEmp.toLowerCase().replace(/\s+/g,'');
    try {
        await fetch(EMPLOYES_URL, {
            method: "POST",
            headers: {
                Authorization: `Bearer ${AIRTABLE_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ records: [{ fields: { NomTable: nomTable, NomAffiche: newEmp, UUID: generateUUID() } }] })
        });
        document.getElementById('newEmployee').value = "";
        loadEmployees();
    } catch (e) {
        console.error(e);
        alert("Erreur ajout employé");
    }
}

// Pointer entrée ou sortie
async function punch(typeAction) {
    const emp = document.getElementById('employeeSelect').value;
    if(!emp) { alert("Choisissez un employé"); return; }
    const now = new Date();
    const heure = now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
    const date = now.toLocaleDateString('fr-FR');
    const uuid = generateUUID();
    try {
        await fetch(POINTAGES_URL, {
            method: "POST",
            headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}`, "Content-Type": "application/json" },
            body: JSON.stringify({ records: [{ fields: { NomComplet: emp, TypeAction: typeAction, Heure: heure, Date: date, UUID: uuid } }] })
        });
        document.getElementById('status').innerText = `✅ ${emp} a pointé ${typeAction} à ${heure}`;
        loadPointages();
    } catch (e) {
        console.error(e);
        document.getElementById('status').innerText = "❌ Erreur pointage";
    }
}

// Charger pointages et calculer temps total
async function loadPointages() {
    const emp = document.getElementById('employeeSelect').value;
    if(!emp) return;
    try {
        const res = await fetch(`${POINTAGES_URL}?filterByFormula={NomComplet}='${emp}'&sort[0][field]=Date&sort[0][direction]=asc`, {
            headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
        });
        const data = await res.json();
        const container = document.getElementById('pointages');
        container.innerHTML = '';
        if(data.records.length === 0) {
            container.innerHTML = "<p>Aucun pointage</p>";
            document.getElementById('totalTime').innerText = "0h 0m";
            return;
        }

        data.records.forEach(rec => {
            const div = document.createElement('div');
            div.className = "pointage-item";
            div.innerHTML = `${rec.fields.Date} ${rec.fields.Heure} (${rec.fields.TypeAction}) UUID: ${rec.fields.UUID} 
                <button onclick="deletePointage('${rec.id}')">Supprimer</button>`;
            container.appendChild(div);
        });

        // Calcul temps total
        let totalMinutes = 0;
        let lastIn = null;
        data.records.forEach(rec => {
            const [h, m] = rec.fields.Heure.split(":").map(Number);
            if(rec.fields.TypeAction === "IN") lastIn = h*60 + m;
            else if(rec.fields.TypeAction === "OUT" && lastIn !== null) {
                totalMinutes += h*60 + m - lastIn;
                lastIn = null;
            }
        });
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        document.getElementById('totalTime').innerText = `${hours}h ${minutes}m`;

    } catch(e) {
        console.error(e);
        document.getElementById('status').innerText = "❌ Erreur chargement pointages";
    }
}

// Supprimer un pointage
async function deletePointage(recordId) {
    if(!confirm("Confirmez la suppression de ce pointage ?")) return;
    try {
        await fetch(`${POINTAGES_URL}/${recordId}`, { method: "DELETE", headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
        loadPointages();
    } catch(e) {
        console.error(e);
        alert("Erreur suppression pointage");
    }
}

// Initialisation
loadEmployees();
</script>

</body>
</html>

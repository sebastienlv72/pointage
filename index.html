<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pointage UUID - SheetDB</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f9; padding: 20px; }
    form { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 12px; margin-bottom: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; border: none; font-weight: bold; color: white; background: #375aff; transition: 0.2s; }
    button:hover:not(:disabled) { background: #003bff; }
    button#resetBtn { background: #e63946; }
    button#resetBtn:hover { background: #b71c1c; }
    #status { margin-top: 15px; font-weight: bold; }
    table { margin: 20px auto; border-collapse: collapse; width: 95%; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; }
    th { background: #375aff; color: white; }
  </style>
</head>
<body>

<h1>📋 Pointage des Heures</h1>

<form id="punchForm">
  <input type="text" id="sheetdbId" placeholder="ID SheetDB ou URL complète" required>
  <input type="text" id="name" placeholder="Nom complet" required>
  <button type="submit" id="punchBtn">Pointer</button>
  <button type="button" id="resetBtn">Réinitialiser</button>
</form>

<p id="status">Statut : en attente...</p>

<table>
  <thead>
    <tr>
      <th>UUID</th>
      <th>Nom</th>
      <th>Action</th>
      <th>Heure</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

<script>
const punchForm = document.getElementById("punchForm");
const punchBtn = document.getElementById("punchBtn");
const resetBtn = document.getElementById("resetBtn");
const sheetdbInput = document.getElementById("sheetdbId");
const nameInput = document.getElementById("name");
const statusDisplay = document.getElementById("status");
const tableBody = document.getElementById("historyTable");

// UUID unique par utilisateur
let userUUID = localStorage.getItem("uuid") || ("uuid-" + Math.random().toString(36).substring(2,9));
localStorage.setItem("uuid", userUUID);

// Charger l'ID SheetDB précédent
if (localStorage.getItem("sheetdb_id")) sheetdbInput.value = localStorage.getItem("sheetdb_id");

// 🧠 Fonction pour extraire l'ID SheetDB même si l'utilisateur colle une URL complète
function extractSheetDBId(input) {
  const match = input.match(/([a-z0-9]{12,})$/i);
  return match ? match[1] : null;
}

// --- Charger historique ---
async function loadHistory(sheetdbId){
  try {
    const res = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}?sort_by=Heure&sort_order=desc`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    tableBody.innerHTML = "";
    if(!Array.isArray(data) || data.length === 0){
      statusDisplay.textContent = "ℹ️ Aucune donnée.";
      return;
    }
    data.forEach(entry => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${entry.UUID}</td><td>${entry.NomComplet}</td><td>${entry.TypeAction}</td><td>${entry.Heure}</td><td>${entry.Date}</td>`;
      tableBody.appendChild(tr);
    });
    statusDisplay.textContent = "✅ Historique chargé.";
  } catch(e){
    console.error(e);
    statusDisplay.textContent = "❌ Erreur de chargement : " + e.message;
  }
}

// --- Déterminer action suivante ---
async function getNextAction(sheetdbId){
  try {
    const res = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}/search?UUID=${userUUID}&sort_by=Heure&sort_order=desc&limit=1`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const lastAction = data[0]?.TypeAction || null;
    return lastAction === "PointageIN" ? "PointageOUT" : "PointageIN";
  } catch {
    return "PointageIN";
  }
}

// --- Ajouter un pointage ---
async function addPunch(sheetdbId, name){
  const action = await getNextAction(sheetdbId);
  const now = new Date();
  const heure = now.toLocaleTimeString("fr-FR", {hour:'2-digit', minute:'2-digit'});
  const date = now.toLocaleDateString("fr-FR");
  const payload = {
    data: [{
      UUID: userUUID,
      NomComplet: name,
      TypeAction: action,
      Heure: heure,
      Date: date
    }]
  };
  punchBtn.disabled = true;
  punchBtn.textContent = "⏳ Envoi...";
  try{
    const res = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    statusDisplay.textContent = `✅ ${name} a pointé ${action === "PointageIN" ? "Entrée" : "Sortie"} à ${heure}`;
    await loadHistory(sheetdbId);
  } catch(e){
    console.error(e);
    statusDisplay.textContent = "❌ Erreur lors de l'enregistrement : " + e.message;
  } finally{
    punchBtn.disabled = false;
    punchBtn.textContent = "Pointer";
  }
}

// --- Réinitialiser la feuille ---
async function resetSheet(sheetdbId){
  if(!confirm("⚠️ Tout sera supprimé. Confirmer ?")) return;
  try{
    const res = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}/all`, { method:"DELETE" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    tableBody.innerHTML = "";
    statusDisplay.textContent = "🗑️ Données supprimées avec succès.";
  } catch(e){
    console.error(e);
    statusDisplay.textContent = "❌ Erreur réinitialisation : " + e.message;
  }
}

// --- Événements ---
punchForm.addEventListener("submit", e=>{
  e.preventDefault();
  let sheetdbId = extractSheetDBId(sheetdbInput.value.trim());
  const name = nameInput.value.trim();
  if(!sheetdbId || !name){
    statusDisplay.textContent="⚠️ Remplir correctement tous les champs.";
    return;
  }
  localStorage.setItem("sheetdb_id", sheetdbId);
  addPunch(sheetdbId, name);
});

resetBtn.addEventListener("click", ()=>{
  let sheetdbId = extractSheetDBId(sheetdbInput.value.trim());
  if(sheetdbId) resetSheet(sheetdbId);
});

// Chargement initial si ID déjà présent
if(sheetdbInput.value) {
  const id = extractSheetDBId(sheetdbInput.value);
  if (id) loadHistory(id);
}
</script>

</body>
</html>

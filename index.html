<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syst√®me de Pointage SheetDB</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f4f4f9;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    #punchForm {
      display: flex;
      flex-direction: column;
      max-width: 350px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    input, button, select {
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background-color: #375aff;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:hover:not(:disabled) {
      background-color: #003bff;
      transform: translateY(-1px);
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 6px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #375aff;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Pointage des Heures (SheetDB)</h1>

  <form id="punchForm">
    <input type="text" id="sheetdbId" placeholder="mmk56vnaeuifx" required>
    <input type="text" id="name" placeholder="Votre Nom Complet" required>
    <button type="submit" id="punchButton">Pointer Entr√©e</button>
    <button type="button" id="resetBtn" style="background:red;">R√©initialiser</button>
  </form>

  <p id="status">üîÑ En attente...</p>

  <h2>Historique des pointages</h2>
  <table id="historyTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Action</th>
        <th>Heure</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const punchForm = document.getElementById("punchForm");
    const punchButton = document.getElementById("punchButton");
    const nameInput = document.getElementById("name");
    const sheetdbInput = document.getElementById("sheetdbId");
    const statusDisplay = document.getElementById("status");
    const tableBody = document.querySelector("#historyTable tbody");
    const resetBtn = document.getElementById("resetBtn");

    let userUUID = localStorage.getItem("uuid") || ("web-" + Math.random().toString(36).substring(2, 9));
    localStorage.setItem("uuid", userUUID);

    // Charger l‚ÄôID SheetDB enregistr√© localement
    if (localStorage.getItem("sheetdb_id")) {
      sheetdbInput.value = localStorage.getItem("sheetdb_id");
    }

    // ===============================
    // üîÑ Charger l‚Äôhistorique
    // ===============================
    async function loadHistory(sheetdbId) {
      try {
        const response = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}?sheet=Pointages&sort_by=Heure&sort_order=desc`);
        if (!response.ok) throw new Error("Erreur HTTP " + response.status);
        const data = await response.json();
        renderTable(data);
      } catch (error) {
        console.error("Erreur de chargement:", error);
        statusDisplay.textContent = "‚ùå Erreur lors du chargement de l‚Äôhistorique.";
      }
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      data.forEach(entry => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.NomComplet}</td>
          <td>${entry.TypeAction === 'PointageIN' ? 'Entr√©e' : 'Sortie'}</td>
          <td>${entry.Heure}</td>
          <td>${entry.Date}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // ===============================
    // üïí V√©rifier dernier pointage
    // ===============================
    async function checkLastAction(sheetdbId, uuid) {
      try {
        const res = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}/search?UUID=${uuid}&sort_by=Heure&sort_order=desc&limit=1`);
        const data = await res.json();
        const last = data[0]?.TypeAction || null;
        return last === "PointageIN" ? "PointageOUT" : "PointageIN";
      } catch (err) {
        console.error(err);
        return "PointageIN";
      }
    }

    // ===============================
    // üìù Enregistrer pointage
    // ===============================
    async function recordPunch(sheetdbId, name, action) {
      const now = new Date();
      const heure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
      const date = now.toLocaleDateString('fr-FR');
      const data = {
        data: [{
          UUID: userUUID,
          NomComplet: name,
          TypeAction: action,
          Heure: heure,
          Date: date
        }]
      };

      try {
        const response = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error("HTTP " + response.status);
        statusDisplay.textContent = `‚úÖ ${name} a point√© ${action === 'PointageIN' ? 'Entr√©e' : 'Sortie'} √† ${heure}`;
        await loadHistory(sheetdbId);
      } catch (err) {
        statusDisplay.textContent = "‚ùå Erreur de connexion √† SheetDB.";
        console.error(err);
      }
    }

    // ===============================
    // üöÆ R√©initialiser la feuille
    // ===============================
    async function resetSheet(sheetdbId) {
      if (!confirm("‚ö†Ô∏è Supprimer toutes les donn√©es de la feuille ?")) return;
      try {
        const response = await fetch(`https://sheetdb.io/api/v1/${sheetdbId}/all`, { method: "DELETE" });
        if (!response.ok) throw new Error("HTTP " + response.status);
        statusDisplay.textContent = "üóëÔ∏è Donn√©es effac√©es avec succ√®s.";
        tableBody.innerHTML = "";
      } catch (error) {
        statusDisplay.textContent = "‚ùå Erreur : impossible de r√©initialiser.";
        console.error(error);
      }
    }

    // ===============================
    // üöÄ Gestion du formulaire
    // ===============================
    punchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const sheetdbId = sheetdbInput.value.trim();

      if (!sheetdbId || !name) {
        statusDisplay.textContent = "‚ö†Ô∏è Entrez votre nom et l‚ÄôID SheetDB.";
        return;
      }

      localStorage.setItem("sheetdb_id", sheetdbId);
      const nextAction = await checkLastAction(sheetdbId, userUUID);
      await recordPunch(sheetdbId, name, nextAction);
    });

    resetBtn.addEventListener("click", () => {
      const sheetdbId = sheetdbInput.value.trim();
      if (sheetdbId) resetSheet(sheetdbId);
    });

    // Auto-chargement si ID enregistr√©
    if (sheetdbInput.value) loadHistory(sheetdbInput.value);
  </script>
</body>
</html>
